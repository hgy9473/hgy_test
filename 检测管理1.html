<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>按照检测类型、检测结果、检测时间、设施类型进行查询</title>
    <style>

        /*查询工具栏 样式*/
        #options{
            border:1px solid #cccccc;
            margin-bottom: 5px;
            display:table;
        }

        label,#infrastructure_type {
            display: inline;
            margin:5px;
        }

        /*显示信息的标签的样式 */
        div#query_result{
            background:#000;
            overflow: auto;
            color:white;
            display: none;
            width:300px;
            height:400px;
            border:1px solid blue;
            position: fixed;
            right:5px;
            top:50px;
            z-index: 10001;
        }
        table{
            width:100%;
        }
        th,td{
            border:1px solid #fff;
        }
        div#table_result{
            border:1px solid red;
            width:150%;
        }
        span#btn_close_table{
            cursor:pointer;
            background-color:#ccc;
            margin-left:250px;
            margin-bottom:350px;
        }
        span#btn_close_table:hover{
            background-color:#eee;
        }

        div#btn_show_table{
            cursor: pointer;
            border: 1px solid blue;
            width:30px;
            height:40px;
            background-image: url(./images/table.png);
            background-size: contain;
            position:fixed;
            right:10px;
            top:40px;
            z-index: 10000;
        }
        div#btn_show_table:hover{
            background-color:#00f;
            opacity: 0.8;
        }

        #road_options,#bridge_options{
            margin-top:5px;
        }
        button{
            margin:5px;
        }
    </style>

</head>
<body onload="init()">
    <div id="options">

        <label>
            设施类型:
            <div name="infrastructure_type" id="infrastructure_type">
                <label><input type="checkbox" value="road" id="road_option"/>道路</label>
                <label><input type="checkbox" value="bridge" id="bridge_option"/>桥梁</label>
            </div>
        </label><br>
        <div id="road_options">

        </div>
        <div id="bridge_options">

        </div>
        <button onclick="show_result()">显示结果</button>
        <button onclick="clear_result()">清除查询结果</button>
    </div>
    <div id="map" style="width:95%;height:580px;"></div>

    <div id="query_result">
        <span id="btn_close_table" style="color:#e00;font-weight: bold;font-size:1.2em">&nbspX&nbsp</span>

    <div id="table_result">
        查询结果表
    </div>
    </div>
    <div id="btn_show_table" title="查看表"></div>
</body>
<!--引用需要的脚本-->
<script src="./libs/SuperMap.Include.js"></script>

<script type="text/javascript">

    //声明变量map、layer、url
    var map, layer,vectorLayer,infowin = null,
            road_table="<table><caption>查询出的道路的属性数据</caption><tr><th>SmId</th><th>长度</th><th>宽度</th></tr>",
            bridge_table="<hr style='height:3px;border:none;border-top:1px solid blue;background-color:#ccc;border-bottom: 1px solid blue' /><br>"+
                    "<table><caption>查询出的桥梁的属性数据</caption><tr><th>名称</th><th>地址</th></tr>",
            style0 = {
                strokeColor: "#f00",
                strokeWidth: 5,
                fillColor:"red"
            },
            style1 = {
                strokeColor: "#0f0",
                strokeWidth: 2,
                fillColor:"red"
            },
            url = "http://localhost:8090/iserver/services/map-chengdu/rest/maps/hgy_test";
    //创建地图控件
    function init() {
        //控件集合
        var options = {controls:[
            new SuperMap.Control.ScaleLine({isImperialUnits:false,geodesic:false}),
            new SuperMap.Control.LayerSwitcher(),
            new SuperMap.Control.PanZoomBar(),//提供平移、缩放按钮
            new SuperMap.Control.Navigation({//导航控件，不可见，可使得鼠标拖动，滚动，双击有用
                dragPanOptions:{
                    enableKinetic:true
                }
            }),
            new SuperMap.Control.OverviewMap()
        ]};
        map = new SuperMap.Map("map",options);

        layer = new SuperMap.Layer.TiledDynamicRESTLayer("Chengdu",
                url,
                null, {maxResolution:"auto"});
        vectorLayer = new SuperMap.Layer.Vector("Vector Layer");//该图层用于渲染矢量要素


        markerLayer = new SuperMap.Layer.Markers("Markers");

        layer.events.on({"layerInitialized": addLayer});
    }

    function addLayer() {
        map.addLayers([layer, vectorLayer,markerLayer]);
        map.setCenter(new SuperMap.LonLat(104.0613,30.6651), 4.00006);//设置中心点，缩放级别
    }

    function show_result(){
        // var check_type = document.getElementById("check_type").value;
        // var check_result = document.getElementById("check_result").value;
        // var check_time = document.getElementById("check_time").value;
        // var infrastructure_type = document.getElementById("infrastructure_type").value;

        // alert("输入--检测结果："+check_result+"检测时间："+check_time+"设施类型："+infrastructure_type+"检测类型："+check_type);
        queryBySQL();

    }


    function queryBySQL() {
        vectorLayer.removeAllFeatures();

        var queryParam, queryParam1,queryBySQLParams, queryBySQLService;

        queryParam = new SuperMap.REST.FilterParameter({// 该类用于设置查询数据集的查询过滤参数
            name:"t_bridge@ryd",
            attributeFilter: "SmId>=3"//属性过滤条件
        });

        queryParam1 = new SuperMap.REST.FilterParameter({// 该类用于设置查询数据集的查询过滤参数
            name: "t_road@ryd",//查询数据集名称或者图层名称。
            attributeFilter: "SmId>=3 and SmId<=500"//属性过滤条件
        });

        queryBySQLParams = new SuperMap.REST.QueryBySQLParameters({//该类用于设置 SQL 查询的相关参数
            queryParams: [queryParam,queryParam1]//查询过滤条件参数数组
        });

        queryBySQLService = new SuperMap.REST.QueryBySQLService(url, {
            //SQL 查询服务类。 在一个或多个指定的图层上查询符合 SQL 条件的空间地物信息
            eventListeners: {
                "processCompleted": processCompleted,
                "processFailed": processFailed
            }
        });
        queryBySQLService.processAsync(queryBySQLParams);
    }

    function processCompleted(queryEventArgs) {
        var road_count = 0,bridge_count = 0;

        var i, j, result = queryEventArgs.result;
        console.log(result);
        if (result && result.recordsets) {
            for (i=0, recordsets=result.recordsets, len=recordsets.length; i<len; i++) {
                if (recordsets[i].features) {
                    for (j=0; j<recordsets[i].features.length; j++) {
                        var feature = recordsets[i].features[j];
                        var point = feature.geometry;
                        if(point.CLASS_NAME == SuperMap.Geometry.Point.prototype.CLASS_NAME){

                            var size = new SuperMap.Size(44, 33),
                                    offset = new SuperMap.Pixel(-(size.w/2), -size.h),
                                    icon = new SuperMap.Icon("./theme/images/marker.png", size, offset);

                            var marker = new SuperMap.Marker(new SuperMap.LonLat(point.x, point.y), icon);

                            bridge_table = bridge_table+"<tr><td>"+feature.attributes.NAME+"</td><td>"+
                                    feature.attributes.ADDRESS+"</td></tr>";
                            bridge_count++;

                            marker.tip_info = "名称："+feature.attributes.NAME+"<br>"+"地址："+feature.attributes.ADDRESS;

                            marker.events.on({
                                "click":openInfoWin,
                                "scope": marker
                            });

                            markerLayer.addMarker(marker);
                        }
                        else
                        {
                            if(j%2==0){
                                feature.style = style0;
                            }else{
                                feature.style = style0;
                            }
                            road_table = road_table+"<tr><td>"+feature.attributes.SmID+"</td><td>"+
                                    feature.attributes.Length+"</td><td>"+feature.attributes.Width+"</td></tr>";
                            road_count++;
                            vectorLayer.addFeatures(feature);
                        }
                    }
                }
            }
        }
        road_table = "<br>总共查出"+road_count+"条路,"+bridge_count+"座桥<br><br>"+road_table+"</table>";
        bridge_table = bridge_table+"</table>";
    }

    function processFailed(e) {
        alert(e.error.errorMsg);
    }

    function openInfoWin(){

        closeInfoWin();
        var marker = this;

        var lonlat = marker.getLonLat();

        var contentHTML = "<div style='font-size:.8em; opacity: 0.8; overflow-y:hidden;'>";
        contentHTML += "<div>"+marker.tip_info+"</div></div>";

        var popup = new SuperMap.Popup.FramedCloud("popwin",
                //具有指向和边框的浮动弹窗。
                new SuperMap.LonLat(lonlat.lon,lonlat.lat),
                null,
                contentHTML);

        infowin = popup;
        map.addPopup(popup);
    }

    function closeInfoWin(){
        if(infowin){
            try{
                infowin.hide();
                infowin.destroy();
            }
            catch(e){}
        }
    }

    //报表显示和隐藏----------------------------------------------------------------------
    document.getElementById("btn_show_table").onclick = function(){
        document.getElementById("table_result").innerHTML =road_table+bridge_table;//装载数据
        document.getElementById("query_result").style.display = "block";//显示属性表
        this.style.display = "none";//隐藏按钮

    }

    document.getElementById("btn_close_table").onclick = function(){
        document.getElementById("query_result").style.display = "none";//隐藏属性表
        document.getElementById("btn_show_table").style.display = "block";//显示按钮
    }


    //加载查询参数----------------------------------------------------------
    function load_options(infrastructure_type){
        var bridge_check_type = "<label>检测类型:<select name='check_type' id='bridge_check_type'>" +
                "<option value='all'>常规定期检测</option><option value='type1'>结构定期检测</option>" +
                "<option value='type2'>特殊检测</option> <option value='type2'>应急检测</option>" +
                "</select></label>";
        var check_result ="<label>检测结果:<select name='check_result' id='check_result'>" +
                "<option value='all'>所有</option><option value='type1'>类型1</option> " +
                "<option value='type2'>类型2</option><option value='type3'>类型3</option>" +
                "</select></label>";
        var check_time ="<label>检测时间:<select name='check_time' id='check_time'>" +
                "<option value='all'>所有</option><option value='type1'>类型1</option>" +
                "<option value='type2'>类型2</option><option value='type3'>类型3</option>" +
                "</select></label>";

        var road_check_type = "<label>检测类型:<select name='check_type' id='road_check_type'>" +
            "<option value='all'>道路定期检测</option><option value='type1'>特殊检测</option>" +
            "<option value='type2'>应急检测</option>" +
            "</select></label>";

        if(infrastructure_type ==="road"){
            var options_road = road_check_type+check_result+check_time;
            document.getElementById("road_options").innerHTML="道路的查询参数:&nbsp"+options_road;
        }

        if(infrastructure_type ==="bridge"){
            var options_bridge = bridge_check_type+check_result+check_time;
            document.getElementById("bridge_options").innerHTML="桥梁的查询参数:&nbsp"+options_bridge;
        }
    }

    var road_option = document.getElementById("road_option");
    road_option.onclick = function () {
        if(this.checked === true){
            load_options("road");
        }else{
            document.getElementById("road_options").innerHTML = "";
        }
    }

    var bridge_option = document.getElementById("bridge_option");
    bridge_option.onclick = function(){
        if(this.checked === true){
            load_options("bridge");
        }else{
            document.getElementById("bridge_options").innerHTML = "";
        }
    }


</script>
</html>